# 调试笔记与项目现状

## 1. 最终目标

实现一个健壮、灵活、动态的，基于“角色-模型”分配的多智能体工作流引擎。

## 2. 已完成的工作

我们已经成功地完成了以下几个主要的重构和功能实现：

-   **动态架构转型**：完全从一个静态的、预定义Agent的架构，重构为了一个在运行时动态创建Agent的架构。
-   **模型管理**：引入了 `src/config/models.json`，用于集中管理所有可用的AI模型。
-   **UI升级**：重构了UI界面，允许用户为工作流中的每一个“角色”动态分配一个“模型”。
-   **密钥轮询**：实现了API密钥池功能。用户可以在UI中为DeepSeek等服务输入多个API密钥，系统会在执行并行任务时自动轮询使用，以提高稳定性和处理能力。
-   **健壮性增强**：引入了专业的 `Mustache.js` 和 `JSONPath-Plus` 库，以替代之前手写的、脆弱的模板渲染和上下文查询逻辑。

## 3. 当前的顽固Bug

尽管我们已经取得了巨大的进展，但目前系统存在一个核心的、阻碍性的bug。

-   **症状**：在运行工作流时，任何带有 `for_each` 循环指令的阶段（Stage）都会被直接跳过。例如，在 `adversarial-math` 工作流中，第一阶段成功执行后，第二阶段（`stage-2-decompose`）的任务没有被执行，工作流直接进入了第三阶段。
-   **根本原因分析**：问题几乎可以肯定出在 `WorkflowEngine.ts` 的 `executeStage` 方法中。该方法负责处理 `for_each` 循环。当它尝试从工作流的上下文中（`context`）为循环准备数据时，`JSONPath` 查询未能找到预期的输入数据数组。因为查询结果为空，所以整个循环体（即该阶段的所有步骤和任务）被跳过。
-   **已尝试的修复**:
    1.  **重构上下文存储**：我重写了 `executeStep` 方法，以确保前一个任务的输出被正确地写入到一个结构化的、可预测的路径下（例如 `context.stages['stage-1-strategies'].output['task-1.1.1-gen-strategies']`）。
    2.  **更新查询路径**：我相应地更新了 `adversarial-math.workflow.json` 文件中的 `for_each` 表达式，使其使用正确的 `JSONPath` 来查询这个新的、正确的路径。
    3.  **简化上下文传递**：我仔细检查并简化了在 `executeStage` 和 `executeStep` 之间传递循环上下文的逻辑，以排除潜在的污染或覆盖问题。

## 4. 下一步调试建议

这个问题非常棘手，因为它发生在数据流的核心环节。要解决它，下一步建议：

1.  **聚焦 `executeStage` 方法**：在 `WorkflowEngine.ts` 的 `executeStage` 方法内部，`const items = JSONPath(...)` 这一行是关键。
2.  **打印完整的上下文**：在该行之前，插入 `console.log(JSON.stringify(context, null, 2));`。
3.  **运行并检查日志**：运行工作流，然后在浏览器的开发者工具控制台中，检查当执行到第二阶段时打印出的 `context` 对象。
4.  **验证路径**：手动验证 `for_each` 中的 `JSONPath` 表达式（例如 `$.stages['stage-1-strategies'].output['task-1.1.1-gen-strategies'].strategies`）是否真的可以在这个打印出的 `context` 对象中找到数据。

这个步骤将明确地告诉我们，是**数据没有被正确写入**，还是**路径查询仍然存在问题**。

祝你休息愉快，希望这份文档能为我们明天的继续调试提供一个清晰的起点。